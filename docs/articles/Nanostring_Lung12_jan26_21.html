<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nanostring CosMx Subcellular Lung Cancer • Giotto Suite</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Nanostring CosMx Subcellular Lung Cancer">
<meta property="og:description" content="Giotto">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-BCXT5392QC"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BCXT5392QC');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Giotto Suite</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">3.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Start
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/getting_started.html#installation">Installation</a>
    </li>
    <li>
      <a href="../articles/getting_started.html#getting-started">Getting Started</a>
    </li>
    <li>
      <a href="../articles/getting_started.html#analyses">Analyses</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Documentation</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Datasets
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/datasets_overview.html#array-based-datasets-1">Array based</a>
    </li>
    <li>
      <a href="../articles/datasets_overview.html#single-cell-1">Single-cell</a>
    </li>
    <li>
      <a href="../articles/datasets_overview.html#subcellular-datasets-1">Subcellular</a>
    </li>
    <li>
      <a href="../articles/datasets_overview.html#protein-multiplexing-1">Protein multiplexing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/contribute.html">Contribute</a>
</li>
<li>
  <a href="../articles/giotto_news.html">News</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    FAQ
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/faqs.html">Frequently Asked Questions</a>
    </li>
    <li>
      <a href="../articles/github_issues.html">GitHub Issues Guidelines</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Try Giotto
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Docker</li>
    <li class="dropdown-header">Binder</li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/drieslab/Giotto/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Nanostring CosMx Subcellular Lung Cancer</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/drieslab/Giotto/blob/HEAD/vignettes/Nanostring_Lung12_jan26_21.Rmd" class="external-link"><code>vignettes/Nanostring_Lung12_jan26_21.Rmd</code></a></small>
      <div class="hidden name"><code>Nanostring_Lung12_jan26_21.Rmd</code></div>

    </div>

    
    
<p><strong>Note:</strong> <em>Figures were produced Jan 26, 2021. The
functions used here can be expected to work in the same ways, but
differences in package versions since then may produce slightly
different results, particularly in PCA, UMAP, clustering, and downstream
functions that use hardcoded annotations based on those different
results.</em></p>
<p>This example uses subcellular data from Nanostring’s CosMx Spatial
Molecular Imager. This publicly available dataset, (which can be found
here: <a href="https://www.nanostring.com/products/cosmx-spatial-molecular-imager/ffpe-dataset/" class="external-link uri">https://www.nanostring.com/products/cosmx-spatial-molecular-imager/ffpe-dataset/</a>)
is from a FFPE sample of non-small-cell lung cancer. This example works
with Lung12.</p>
<div class="section level2">
<h2 id="start-giotto">1. Start Giotto<a class="anchor" aria-label="anchor" href="#start-giotto"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load Giotto, data.table is also necessary for this example</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://drieslab.github.io/Giotto/" class="external-link">Giotto</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="co"># add color palettes if you want!</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Nowosad/rcartocolor" class="external-link">rcartocolor</a></span><span class="op">)</span></span>
<span><span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rcartocolor/man/carto_pal.html" class="external-link">carto_pal</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">10</span>, <span class="st">"Pastel"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set working directory</span></span>
<span><span class="va">results_folder</span> <span class="op">=</span> <span class="st">'/path/to/directory'</span></span>
<span></span>
<span><span class="co"># set giotto python path</span></span>
<span><span class="co"># set python path to your preferred python version path</span></span>
<span><span class="co"># set python path to NULL if you want to automatically install (only the 1st time) and use the giotto miniconda environment</span></span>
<span><span class="va">python_path</span> <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">python_path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/installGiottoEnvironment.html">installGiottoEnvironment</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co">## create instructions</span></span>
<span><span class="co"># by directly saving plots, but not rendering them you will save a lot of time</span></span>
<span><span class="va">instrs</span> <span class="op">=</span> <span class="fu"><a href="../reference/createGiottoInstructions.html">createGiottoInstructions</a></span><span class="op">(</span>save_dir <span class="op">=</span> <span class="va">results_folder</span>,</span>
<span>                                  save_plot <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                  show_plot <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                  return_plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="cosmx-project-loading-function">CosMx Project loading function<a class="anchor" aria-label="anchor" href="#cosmx-project-loading-function"></a>
</h2>
<details><summary>
Convenience function that performs steps 2-4
</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## provide path to nanostring folder</span></span>
<span><span class="va">data_path</span> <span class="op">=</span> <span class="st">'/path/to/data/Lung12-Flat_files_and_images/'</span></span>
<span></span>
<span><span class="co">## create giotto cosmx object</span></span>
<span><span class="va">fov_join</span> <span class="op">=</span> <span class="fu"><a href="../reference/createGiottoCosMxObject.html">createGiottoCosMxObject</a></span><span class="op">(</span>cosmx_dir <span class="op">=</span> <span class="va">data_path</span>,</span>
<span>                                   data_to_use <span class="op">=</span> <span class="st">'subcellular'</span>,</span>
<span>                                   FOVs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span>,</span>
<span>                                   instructions <span class="op">=</span> <span class="va">instrs</span><span class="op">)</span></span></code></pre></div>
</details>
</div>
<div class="section level2">
<h2 id="load-in-data">2. Load in Data<a class="anchor" aria-label="anchor" href="#load-in-data"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## provide path to nanostring folder</span></span>
<span><span class="va">data_path</span> <span class="op">=</span> <span class="st">'/path/to/data/Lung12-Flat_files_and_images/'</span></span>
<span></span>
<span><span class="co"># load transcript coordinates</span></span>
<span><span class="va">tx_coord_all</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">'Lung12_tx_file.csv'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#  load field of vision (fov) positions</span></span>
<span><span class="va">fov_offset_file</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html" class="external-link">fread</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">'Lung12_fov_positions_file.csv'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="choose-field-of-view-for-analysis">Choose field of view for analysis<a class="anchor" aria-label="anchor" href="#choose-field-of-view-for-analysis"></a>
</h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gobjects_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># select which FOV's you would like to work with</span></span>
<span><span class="co"># the dataset includes 28, which is too much for most computers to handle at once. </span></span>
<span><span class="co">#For this example I am using 02, 03, and 04</span></span>
<span><span class="va">id_set</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'02'</span>, <span class="st">'03'</span>, <span class="st">'04'</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="create-a-giotto-object-for-each-fov">3. Create a Giotto Object for each FOV<a class="anchor" aria-label="anchor" href="#create-a-giotto-object-for-each-fov"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">fov_i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">id_set</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">fov_id</span> <span class="op">=</span> <span class="va">id_set</span><span class="op">[</span><span class="va">fov_i</span><span class="op">]</span></span>
<span></span>
<span></span>
<span>  <span class="co"># 1. original composite image as png</span></span>
<span>  <span class="va">original_composite_image</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">'CellComposite/CellComposite_F0'</span>, <span class="va">fov_id</span>,<span class="st">'.jpg'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># 2. input cell segmentation as mask file</span></span>
<span>  <span class="va">segmentation_mask</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">data_path</span>, <span class="st">'CellLabels/CellLabels_F0'</span>, <span class="va">fov_id</span>, <span class="st">'.tif'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># 3. input features coordinates + offset</span></span>
<span>  <span class="va">tx_coord</span> <span class="op">=</span> <span class="va">tx_coord_all</span><span class="op">[</span><span class="va">fov</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">fov_id</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">tx_coord</span> <span class="op">=</span> <span class="va">tx_coord</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">x_local_px</span>, <span class="va">y_local_px</span>, <span class="va">z</span>, <span class="va">target</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="../reference/row-plus-colnames-generic.html">colnames</a></span><span class="op">(</span><span class="va">tx_coord</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'x'</span>, <span class="st">'y'</span>, <span class="st">'z'</span>, <span class="st">'gene_id'</span><span class="op">)</span></span>
<span>  <span class="va">tx_coord</span> <span class="op">=</span> <span class="va">tx_coord</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">gene_id</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">fovsubset</span> <span class="op">=</span> <span class="fu"><a href="../reference/createGiottoObjectSubcellular.html">createGiottoObjectSubcellular</a></span><span class="op">(</span>gpoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'rna'</span> <span class="op">=</span> <span class="va">tx_coord</span><span class="op">)</span>,</span>
<span>                                            gpolygons <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'cell'</span> <span class="op">=</span> <span class="va">segmentation_mask</span><span class="op">)</span>,</span>
<span>                                            polygon_mask_list_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mask_method <span class="op">=</span> <span class="st">'guess'</span>,</span>
<span>                                                                            flip_vertical <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                                                            flip_horizontal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                                                            shift_horizontal_step <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>                                            instructions <span class="op">=</span> <span class="va">instrs</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># centroids are now used to provide the spatial locations (centroid of each cell)</span></span>
<span>  <span class="va">fovsubset</span> <span class="op">=</span> <span class="fu"><a href="../reference/addSpatialCentroidLocations.html">addSpatialCentroidLocations</a></span><span class="op">(</span><span class="va">fovsubset</span>,</span>
<span>                                          poly_info <span class="op">=</span> <span class="st">'cell'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># create and add Giotto images</span></span>
<span>  <span class="va">composite</span> <span class="op">=</span> <span class="fu"><a href="../reference/createGiottoLargeImage.html">createGiottoLargeImage</a></span><span class="op">(</span>raster_object <span class="op">=</span> <span class="va">original_composite_image</span>,</span>
<span>                                     negative_y <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                     name <span class="op">=</span> <span class="st">'composite'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">fovsubset</span> <span class="op">=</span> <span class="fu"><a href="../reference/addGiottoImage.html">addGiottoImage</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fovsubset</span>,</span>
<span>                             largeImages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">composite</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="va">fovsubset</span> <span class="op">=</span> <span class="fu"><a href="../reference/convertGiottoLargeImageToMG.html">convertGiottoLargeImageToMG</a></span><span class="op">(</span>giottoLargeImage <span class="op">=</span> <span class="va">composite</span>,</span>
<span>                                          <span class="co">#mg_name = 'composite',</span></span>
<span>                                          gobject <span class="op">=</span> <span class="va">fovsubset</span>,</span>
<span>                                          return_gobject <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">gobjects_list</span><span class="op">[[</span><span class="va">fov_i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">fovsubset</span></span>
<span>  </span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="join-giotto-objects">4. Join Giotto Objects<a class="anchor" aria-label="anchor" href="#join-giotto-objects"></a>
</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"fov0"</span>, <span class="va">id_set</span><span class="op">)</span></span>
<span></span>
<span><span class="va">id_match</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">id_set</span><span class="op">)</span>, <span class="va">fov_offset_file</span><span class="op">$</span><span class="va">fov</span><span class="op">)</span></span>
<span><span class="va">x_shifts</span> <span class="op">=</span> <span class="va">fov_offset_file</span><span class="op">[</span><span class="va">id_match</span><span class="op">]</span><span class="op">$</span><span class="va">x_global_px</span></span>
<span><span class="va">y_shifts</span> <span class="op">=</span> <span class="va">fov_offset_file</span><span class="op">[</span><span class="va">id_match</span><span class="op">]</span><span class="op">$</span><span class="va">y_global_px</span></span>
<span></span>
<span><span class="co"># Create Giotto object that includes all selected FOVs</span></span>
<span><span class="va">fov_join</span> <span class="op">=</span> <span class="fu"><a href="../reference/joinGiottoObjects.html">joinGiottoObjects</a></span><span class="op">(</span>gobject_list <span class="op">=</span> <span class="va">gobjects_list</span>,</span>
<span>                             gobject_names <span class="op">=</span> <span class="va">new_names</span>,</span>
<span>                             join_method <span class="op">=</span> <span class="st">'shift'</span>,</span>
<span>                             x_shift <span class="op">=</span> <span class="va">x_shifts</span>,</span>
<span>                             y_shift <span class="op">=</span> <span class="va">y_shifts</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualize-cells-and-genes-of-interest">5. Visualize Cells and Genes of Interest<a class="anchor" aria-label="anchor" href="#visualize-cells-and-genes-of-interest"></a>
</h2>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/showGiottoImageNames.html">showGiottoImageNames</a></span><span class="op">(</span><span class="va">fov_join</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set up vector of image names</span></span>
<span><span class="va">id_set</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'02'</span>, <span class="st">'03'</span>, <span class="st">'04'</span><span class="op">)</span></span>
<span><span class="va">new_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"fov0"</span>, <span class="va">id_set</span><span class="op">)</span></span>
<span><span class="va">image_names</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">new_names</span>, <span class="st">'-image'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/spatInSituPlotPoints.html">spatInSituPlotPoints</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>                     show_image <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     image_name <span class="op">=</span> <span class="va">image_names</span>,</span>
<span>                     feats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'rna'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MMP2"</span>, <span class="st">"VEGFA"</span>, <span class="st">"IGF1R"</span>,</span>
<span>                                            <span class="st">'CDH2'</span>, <span class="st">'MKI67'</span>, <span class="st">'EPCAM'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     spat_unit <span class="op">=</span> <span class="st">'cell'</span>,</span>
<span>                     point_size <span class="op">=</span> <span class="fl">0.15</span>,</span>
<span>                     show_polygon <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     use_overlap <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                     polygon_feat_type <span class="op">=</span> <span class="st">'cell'</span>,</span>
<span>                     polygon_color <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>                     polygon_line_size <span class="op">=</span> <span class="fl">0.02</span>,</span>
<span>                     coord_fix_ratio <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     background_color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1272022/Rplot1.png" style="width:175.0%"></p>
<div class="section level4">
<h4 id="visualize-cells">Visualize Cells<a class="anchor" aria-label="anchor" href="#visualize-cells"></a>
</h4>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spatPlot2D.html">spatPlot2D</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>           image_name <span class="op">=</span> <span class="va">image_names</span>,</span>
<span>           show_image <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>           point_size <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>           coord_fix_ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1272022/Rplot2.png" style="width:150.0%"></p>
</div>
</div>
<div class="section level2">
<h2 id="extract-data-from-your-giotto-object">6. Extract Data from your Giotto Object<a class="anchor" aria-label="anchor" href="#extract-data-from-your-giotto-object"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fov_join</span> <span class="op">=</span> <span class="fu"><a href="../reference/calculateOverlapRaster.html">calculateOverlapRaster</a></span><span class="op">(</span><span class="va">fov_join</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fov_join</span> <span class="op">=</span> <span class="fu"><a href="../reference/overlapToMatrix.html">overlapToMatrix</a></span><span class="op">(</span><span class="va">fov_join</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/showGiottoExpression.html">showGiottoExpression</a></span><span class="op">(</span><span class="va">fov_join</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine cell data</span></span>
<span><span class="va">morphometa</span> <span class="op">=</span> <span class="fu"><a href="../reference/combineCellData.html">combineCellData</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>                             feat_type <span class="op">=</span> <span class="st">'rna'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine feature data</span></span>
<span><span class="va">featmeta</span> <span class="op">=</span> <span class="fu"><a href="../reference/combineFeatureData.html">combineFeatureData</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>                              feat_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'rna'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine overlapping feature data</span></span>
<span><span class="va">featoverlapmeta</span> <span class="op">=</span> <span class="fu"><a href="../reference/combineFeatureOverlapData.html">combineFeatureOverlapData</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>                                            feat_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'rna'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="process-giotto-object">7. Process Giotto Object<a class="anchor" aria-label="anchor" href="#process-giotto-object"></a>
</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># filter</span></span>
<span><span class="va">fov_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filterGiotto.html">filterGiotto</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>                         expression_threshold <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                         feat_det_in_min_cells <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                         min_det_feats_per_cell <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># normalize</span></span>
<span><span class="co"># standard method</span></span>
<span><span class="va">fov_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/normalizeGiotto.html">normalizeGiotto</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>                            scalefactor <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>                            verbose <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># new normalizaton method based on pearson correlations (Lause/Kobak et al. 2021)</span></span>
<span><span class="co"># this normalized matrix is given the name 'pearson' and will be used in the downstream steps</span></span>
<span><span class="va">fov_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/normalizeGiotto.html">normalizeGiotto</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>                            scalefactor <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>                            verbose <span class="op">=</span> <span class="cn">T</span>,</span>
<span>                            norm_methods <span class="op">=</span> <span class="st">'pearson_resid'</span>,</span>
<span>                            update_slot <span class="op">=</span> <span class="st">'pearson'</span><span class="op">)</span></span>
<span><span class="co"># add statistics</span></span>
<span><span class="va">fov_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addStatistics.html">addStatistics</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View cellular data</span></span>
<span><span class="fu"><a href="../reference/pDataDT.html">pDataDT</a></span><span class="op">(</span><span class="va">fov_join</span><span class="op">)</span></span>
<span><span class="co"># View rna data</span></span>
<span><span class="fu"><a href="../reference/fDataDT.html">fDataDT</a></span><span class="op">(</span><span class="va">fov_join</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="view-transcript-number-distribution">8. View Transcript Number Distribution<a class="anchor" aria-label="anchor" href="#view-transcript-number-distribution"></a>
</h2>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cellmeta</span> <span class="op">=</span> <span class="fu"><a href="../reference/pDataDT.html">pDataDT</a></span><span class="op">(</span><span class="va">fov_join</span>, feat_type <span class="op">=</span> <span class="st">'rna'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">cellmeta</span><span class="op">$</span><span class="va">nr_feats</span>, <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1262022/Rplothist.png" style="width:50.0%"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spatPlot2D.html">spatPlot2D</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>           cell_color <span class="op">=</span> <span class="st">'total_expr'</span>,</span>
<span>           color_as_factor <span class="op">=</span> <span class="cn">F</span>,</span>
<span>           show_image <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>           image_name <span class="op">=</span> <span class="va">image_names</span>,</span>
<span>           point_size <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>           point_alpha <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>           coord_fix_ratio <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1272022/Rplot3.png" style="width:150.0%"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spatInSituPlotPoints.html">spatInSituPlotPoints</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>                     show_polygon <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     polygon_color <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>                     polygon_line_size <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>                     polygon_fill <span class="op">=</span> <span class="st">'total_expr'</span>,</span>
<span>                     polygon_fill_as_factor <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                     coord_fix_ratio <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1272022/Rplot5.png" style="width:150.0%"></p>
</div>
<div class="section level2">
<h2 id="dimension-reduction">9. Dimension Reduction<a class="anchor" aria-label="anchor" href="#dimension-reduction"></a>
</h2>
<div class="section level4">
<h4 id="calculate-highly-variable-genes">Calculate Highly Variable Genes<a class="anchor" aria-label="anchor" href="#calculate-highly-variable-genes"></a>
</h4>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># typical way of calculating HVG</span></span>
<span><span class="va">fov_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculateHVF.html">calculateHVF</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>                         HVFname <span class="op">=</span> <span class="st">'hvg_orig'</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/4-HVFplot.png" style="width:50.0%"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># new method based on variance of pearson residuals for each gene</span></span>
<span><span class="va">fov_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculateHVF.html">calculateHVF</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>                         method <span class="op">=</span> <span class="st">'var_p_resid'</span>,</span>
<span>                         expression_values <span class="op">=</span> <span class="st">'pearson'</span>,</span>
<span>                         show_plot <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/5-HVFplot.png" style="width:50.0%"></p>
</div>
<div class="section level4">
<h4 id="view-highly-variable-features">View Highly Variable Features<a class="anchor" aria-label="anchor" href="#view-highly-variable-features"></a>
</h4>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_meta</span> <span class="op">=</span> <span class="fu"><a href="../reference/fDataDT.html">fDataDT</a></span><span class="op">(</span><span class="va">fov_join</span><span class="op">)</span></span>
<span><span class="va">gene_meta</span><span class="op">[</span><span class="va">hvf</span> <span class="op">==</span> <span class="st">'yes'</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="run-pca">Run PCA<a class="anchor" aria-label="anchor" href="#run-pca"></a>
</h4>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fov_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runPCA.html">runPCA</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>                   expression_values <span class="op">=</span> <span class="st">'pearson'</span>,</span>
<span>                   scale_unit <span class="op">=</span> <span class="cn">F</span>,</span>
<span>                   center <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/screePlot.html">screePlot</a></span><span class="op">(</span><span class="va">fov_join</span>, ncp <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/6-screePlot.png" style="width:50.0%"></p>
</div>
<div class="section level4">
<h4 id="plot-pca">Plot PCA<a class="anchor" aria-label="anchor" href="#plot-pca"></a>
</h4>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotPCA.html">plotPCA</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>        dim1_to_use <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        dim2_to_use <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/7-PCA.png" style="width:50.0%"></p>
</div>
<div class="section level4">
<h4 id="run-umap">Run UMAP<a class="anchor" aria-label="anchor" href="#run-umap"></a>
</h4>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fov_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runUMAP.html">runUMAP</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>                    dimensions_to_use <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>                    n_threads <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plotUMAP.html">plotUMAP</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/8-UMAP.png" style="width:50.0%"></p>
</div>
</div>
<div class="section level2">
<h2 id="cluster">10. Cluster<a class="anchor" aria-label="anchor" href="#cluster"></a>
</h2>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fov_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createNearestNetwork.html">createNearestNetwork</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>                                 dimensions_to_use <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>                                 k <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">fov_join</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/doLeidenCluster.html">doLeidenCluster</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>                            resolution <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                            n_iterations <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize UMAP cluster results</span></span>
<span><span class="fu"><a href="../reference/plotUMAP.html">plotUMAP</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>         cell_color <span class="op">=</span> <span class="st">'leiden_clus'</span>,</span>
<span>         show_NN_network <span class="op">=</span> <span class="cn">T</span>,</span>
<span>         point_size <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/9-UMAP.png" style="width:50.0%"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># visualize UMAP and spatial results</span></span>
<span><span class="fu"><a href="../reference/spatDimPlot2D.html">spatDimPlot2D</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>              show_image <span class="op">=</span> <span class="cn">T</span>,</span>
<span>              image_name <span class="op">=</span> <span class="va">image_names</span>,</span>
<span>              cell_color <span class="op">=</span> <span class="st">'leiden_clus'</span>,</span>
<span>              spat_point_size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/10-spatDimPlot2D.png" style="width:50.0%"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spatInSituPlotPoints.html">spatInSituPlotPoints</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>                     feats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'rna'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MMP2"</span>, <span class="st">"VEGFA"</span>, <span class="st">"IGF1R"</span>,</span>
<span>                                            <span class="st">'CDH2'</span>, <span class="st">'MKI67'</span>, <span class="st">'EPCAM'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     point_size <span class="op">=</span> <span class="fl">0.15</span>,</span>
<span>                     show_polygon <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     polygon_color <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>                     polygon_line_size <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>                     polygon_fill <span class="op">=</span> <span class="st">'leiden_clus'</span>,</span>
<span>                     polygon_fill_as_factor <span class="op">=</span> <span class="cn">T</span>,</span>
<span>                     coord_fix_ratio <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1272022/spatinsituclustered.png" style="width:150.0%"></p>
</div>
<div class="section level2">
<h2 id="small-subset-visiualization">11. Small Subset Visiualization<a class="anchor" aria-label="anchor" href="#small-subset-visiualization"></a>
</h2>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">locs</span> <span class="op">&lt;-</span><span class="va">fov_join</span><span class="op">@</span><span class="va">spatial_locs</span><span class="op">$</span><span class="va">cell</span><span class="op">$</span><span class="va">raw</span></span>
<span></span>
<span><span class="co">#subset a Giotto object based on spatial locations</span></span>
<span><span class="va">smallfov</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subsetGiottoLocs.html">subsetGiottoLocs</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>                         x_max <span class="op">=</span> <span class="fl">800</span>,</span>
<span>                         x_min <span class="op">=</span> <span class="fl">507</span>,</span>
<span>                         y_max <span class="op">=</span> <span class="op">-</span><span class="fl">158800</span>,</span>
<span>                         y_min <span class="op">=</span> <span class="op">-</span><span class="fl">159600</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#extract all genes observed in new object</span></span>
<span><span class="va">smallfeats</span> <span class="op">&lt;-</span> <span class="va">smallfov</span><span class="op">@</span><span class="va">feat_metadata</span><span class="op">$</span><span class="va">cell</span><span class="op">$</span><span class="va">rna</span><span class="op">$</span><span class="va">feat_ID</span></span>
<span></span>
<span><span class="co">#plot all genes</span></span>
<span><span class="fu"><a href="../reference/spatInSituPlotPoints.html">spatInSituPlotPoints</a></span><span class="op">(</span><span class="va">smallfov</span>,</span>
<span>                     feats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">smallfeats</span><span class="op">)</span>,</span>
<span>                     point_size <span class="op">=</span> <span class="fl">0.15</span>,</span>
<span>                     polygon_line_size <span class="op">=</span> <span class="fl">.1</span>,</span>
<span>                     show_polygon <span class="op">=</span> <span class="cn">T</span>,</span>
<span>                     polygon_color <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>                     show_image <span class="op">=</span> <span class="cn">T</span>,</span>
<span>                     image_name <span class="op">=</span> <span class="va">image_names</span>,</span>
<span>                     coord_fix_ratio <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     show_legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/12-spatInSituPlotPoints.png" style="width:75.0%"></p>
</div>
<div class="section level2">
<h2 id="spatial-expression-patterns">12. Spatial Expression Patterns<a class="anchor" aria-label="anchor" href="#spatial-expression-patterns"></a>
</h2>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create spatial network based on physical distance of cell centroids</span></span>
<span><span class="va">fov_join</span> <span class="op">=</span> <span class="fu"><a href="../reference/createSpatialNetwork.html">createSpatialNetwork</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>                                minimum_k <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                maximum_distance_delaunay <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># select features</span></span>
<span><span class="va">feats</span> <span class="op">=</span> <span class="va">fov_join</span><span class="op">@</span><span class="va">feat_ID</span><span class="op">$</span><span class="va">rna</span></span>
<span><span class="co"># perform Binary Spatial Extraction of genes - NOTE: Depending on your system this could take time</span></span>
<span><span class="va">km_spatialgenes</span> <span class="op">=</span> <span class="fu"><a href="../reference/binSpect.html">binSpect</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>                           subset_feats <span class="op">=</span> <span class="va">feats</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># visualize spatial expression of selected genes obtained from binSpect</span></span>
<span><span class="fu"><a href="../reference/spatFeatPlot2D.html">spatFeatPlot2D</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>               expression_values <span class="op">=</span> <span class="st">'scaled'</span>,</span>
<span>               feats <span class="op">=</span> <span class="va">km_spatialgenes</span><span class="op">$</span><span class="va">feats</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>,</span>
<span>               cell_color_gradient <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'blue'</span>, <span class="st">'white'</span>, <span class="st">'red'</span><span class="op">)</span>,</span>
<span>               point_shape <span class="op">=</span> <span class="st">'border'</span>,</span>
<span>               point_border_stroke <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>               show_network <span class="op">=</span> <span class="cn">F</span>,</span>
<span>               network_color <span class="op">=</span> <span class="st">'lightgrey'</span>,</span>
<span>               point_size <span class="op">=</span> <span class="fl">1.2</span>,</span>
<span>               cow_n_col <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/13-spatFeatPlot2D.png" style="width:50.0%"></p>
</div>
<div class="section level2">
<h2 id="identify-clusters">13. Identify Clusters<a class="anchor" aria-label="anchor" href="#identify-clusters"></a>
</h2>
<div class="section level3">
<h3 id="violin-plot">Violin plot<a class="anchor" aria-label="anchor" href="#violin-plot"></a>
</h3>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">markers</span> <span class="op">=</span> <span class="fu"><a href="../reference/findMarkers_one_vs_all.html">findMarkers_one_vs_all</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>                                 method <span class="op">=</span> <span class="st">'gini'</span>,</span>
<span>                                 expression_values <span class="op">=</span> <span class="st">'normalized'</span>,</span>
<span>                                 cluster_column <span class="op">=</span> <span class="st">'leiden_clus'</span>,</span>
<span>                                 min_feats <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                 rank_score <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">markers</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="fl">5</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">'cluster'</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># violinplot</span></span>
<span><span class="va">topgini_genes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">markers</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="fl">2</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">'cluster'</span><span class="op">]</span><span class="op">$</span><span class="va">feats</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/violinPlot.html">violinPlot</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>           feats <span class="op">=</span> <span class="va">topgini_genes</span>,</span>
<span>           cluster_column <span class="op">=</span> <span class="st">'leiden_clus'</span>,</span>
<span>           strip_position <span class="op">=</span> <span class="st">'right'</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/14-violinPlot.png" style="width:50.0%"></p>
</div>
<div class="section level3">
<h3 id="heatmap">Heatmap<a class="anchor" aria-label="anchor" href="#heatmap"></a>
</h3>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster_order</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">8</span>, <span class="fl">9</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plotMetaDataHeatmap.html">plotMetaDataHeatmap</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>                    expression_values <span class="op">=</span> <span class="st">'scaled'</span>,</span>
<span>                    metadata_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'leiden_clus'</span><span class="op">)</span>,</span>
<span>                    selected_feats <span class="op">=</span> <span class="va">topgini_genes</span>,</span>
<span>                    custom_cluster_order <span class="op">=</span> <span class="va">cluster_order</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1262022/6-plotMetaDataHeatmap.png" style="width:50.0%"></p>
</div>
<div class="section level3">
<h3 id="annotate-giotto-object">Annotate Giotto Object<a class="anchor" aria-label="anchor" href="#annotate-giotto-object"></a>
</h3>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## add cell types ###</span></span>
<span><span class="va">clusters_cell_types_lung</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Normal Epithelial'</span>, <span class="st">'Cancer'</span>, <span class="st">'Stromal'</span>, <span class="st">'Plasma Cells'</span>,</span>
<span>                             <span class="st">'Cytotoxic T Cells'</span>, <span class="st">'Cancer Stem Cells'</span>,</span>
<span>                             <span class="st">'Macrophage'</span>, <span class="st">'Memory B Cell'</span>, <span class="st">'Memory B Cell'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">clusters_cell_types_lung</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">cluster_order</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fov_join</span> <span class="op">=</span> <span class="fu"><a href="../reference/annotateGiotto.html">annotateGiotto</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>                          annotation_vector <span class="op">=</span> <span class="va">clusters_cell_types_lung</span>,</span>
<span>                          cluster_column <span class="op">=</span> <span class="st">'leiden_clus'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plotUMAP.html">plotUMAP</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>         cell_color <span class="op">=</span> <span class="st">'cell_types'</span>,</span>
<span>         point_size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/15-UMAP.png" style="width:50.0%"></p>
</div>
<div class="section level3">
<h3 id="visualize">Visualize<a class="anchor" aria-label="anchor" href="#visualize"></a>
</h3>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spatDimPlot2D.html">spatDimPlot2D</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>              show_image <span class="op">=</span> <span class="cn">T</span>,</span>
<span>              image_name <span class="op">=</span> <span class="va">image_names</span>,</span>
<span>              cell_color <span class="op">=</span> <span class="st">'cell_types'</span>,</span>
<span>              spat_point_size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/16-spatDimPlot2D.png" style="width:50.0%"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/spatInSituPlotPoints.html">spatInSituPlotPoints</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>                     show_polygon <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     polygon_feat_type <span class="op">=</span> <span class="st">'cell'</span>,</span>
<span>                     polygon_color <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>                     polygon_line_size <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>                     polygon_fill <span class="op">=</span> <span class="st">'cell_types'</span>,</span>
<span>                     polygon_fill_as_factor <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     coord_fix_ratio <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/17-spatInSituPlotPoints.png" style="width:50.0%"></p>
</div>
</div>
<div class="section level2">
<h2 id="interaction-changed-genes">14. Interaction Changed Genes<a class="anchor" aria-label="anchor" href="#interaction-changed-genes"></a>
</h2>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="st">'multisession'</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="co"># NOTE: Depending on your system this could take time</span></span>
<span></span>
<span><span class="va">goi</span> <span class="op">=</span> <span class="fu"><a href="../reference/findInteractionChangedFeats.html">findInteractionChangedFeats</a></span><span class="op">(</span>gobject <span class="op">=</span> <span class="va">fov_join</span>,</span>
<span>                                  cluster_column <span class="op">=</span> <span class="st">'leiden_clus'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Identify top ten interaction changed genes</span></span>
<span><span class="va">goi</span><span class="op">$</span><span class="va">CPGscores</span><span class="op">[</span><span class="va">type_int</span> <span class="op">==</span> <span class="st">'hetero'</span><span class="op">]</span><span class="op">$</span><span class="va">feats</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Visualize ICG expression</span></span>
<span><span class="fu"><a href="../reference/spatInSituPlotPoints.html">spatInSituPlotPoints</a></span><span class="op">(</span><span class="va">fov_join</span>,</span>
<span>                     feats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">goi</span><span class="op">$</span><span class="va">CPGscores</span><span class="op">[</span><span class="va">type_int</span> <span class="op">==</span> <span class="st">'hetero'</span><span class="op">]</span><span class="op">$</span><span class="va">feats</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                     point_size <span class="op">=</span> <span class="fl">0.15</span>,</span>
<span>                     show_polygon <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     polygon_feat_type <span class="op">=</span> <span class="st">'cell'</span>,</span>
<span>                     polygon_color <span class="op">=</span> <span class="st">'black'</span>,</span>
<span>                     polygon_line_size <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>                     polygon_fill <span class="op">=</span> <span class="st">'cell_types'</span>,</span>
<span>                     polygon_fill_as_factor <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     polygon_fill_code <span class="op">=</span> <span class="va">pal</span>,</span>
<span>                     coord_fix_ratio <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="../inst/images/nanostring_CosMx_Lung12/Emma/results-1252022/18-spatInSituPlotPoints.png" style="width:50.0%"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://www.drieslab.com/" class="external-link">Ruben Dries</a>, Jiaji George Chen, Natalie Del Rossi, Emma Kelley, Junxiang Xu, Guo-Cheng Yuan, Matthew O’Brien, Joselyn Chávez.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
